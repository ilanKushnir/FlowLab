---
- name: Deploy FlowLab to Raspberry Pi
  hosts: raspberry_pi
  become: true
  gather_facts: true
  timeout: 1800  # 30 minutes max
  
  vars:
    project_name: homeai
    remote_project_path: "/opt/{{ project_name }}"
    required_packages:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - git
      - docker.io
      - docker-compose
      - jq
    homeai_user: homeai
    homeai_group: homeai
    ansible_ssh_timeout: 30
    
  pre_tasks:
    - name: "ğŸ§ª FlowLab Deployment Starting"
      debug:
        msg: |
          ğŸ§ª FlowLab - Your Personal Automation Laboratory
          ğŸ“¡ Deploying to: {{ ansible_host }}
          ğŸš€ Where workflows come to life!
        
    - name: "ğŸ”Œ Test connectivity"
      ping:
      timeout: 10
      
    - name: "ğŸ’¾ Check disk space"
      shell: df -h / | awk 'NR==2 {print $4}' | sed 's/G//'
      register: disk_space
      changed_when: false
      
    - name: "âš ï¸  Verify sufficient disk space"
      fail:
        msg: "Insufficient disk space. Need at least 8GB, found {{ disk_space.stdout }}GB"
      when: disk_space.stdout | int < 8

  tasks:
    - name: "ğŸ“¦ Update package cache"
      apt:
        update_cache: yes
        cache_valid_time: 3600
      timeout: 300
      
    - name: "â¬†ï¸  Upgrade system packages"
      apt:
        upgrade: dist
        autoclean: yes
        autoremove: yes
      timeout: 900
      
    - name: "ğŸ“‹ Install required packages"
      apt:
        name: "{{ required_packages }}"
        state: present
      timeout: 600
        
    - name: "ğŸ‘¥ Create homeai group"
      group:
        name: "{{ homeai_group }}"
        state: present
        
    - name: "ğŸ‘¤ Create homeai user"
      user:
        name: "{{ homeai_user }}"
        group: "{{ homeai_group }}"
        groups: docker
        shell: /bin/bash
        create_home: yes
        state: present
        
    - name: "ğŸ³ Add pi user to docker group"
      user:
        name: pi
        groups: docker
        append: yes
        
    - name: "ğŸš€ Enable and start Docker service"
      systemd:
        name: docker
        enabled: yes
        state: started
        
    - name: "â³ Wait for Docker to be ready"
      wait_for:
        path: /var/run/docker.sock
        timeout: 60
        
    - name: "âœ… Verify Docker is working"
      command: docker --version
      register: docker_verify
      changed_when: false
        
    - name: "ğŸ§¹ Clean up any existing problematic volumes"
      shell: |
        # Stop any existing containers
        cd {{ remote_project_path }} && docker-compose down || true
        # Remove problematic volumes that might have directories instead of files
        docker volume rm homeai_freqtrade_data || true
      become_user: "{{ homeai_user }}"
      ignore_errors: true
      
    - name: "ğŸ“ Create project directories"
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ homeai_user }}"
        group: "{{ homeai_group }}"
        mode: '0755'
      loop:
        - "{{ remote_project_path }}"
        - "{{ remote_project_path }}/services"
        - "{{ remote_project_path }}/services/freqtrade"
        - "{{ remote_project_path }}/services/freqtrade/strategies"
        - "{{ remote_project_path }}/services/searxng"
        - "{{ remote_project_path }}/workflows"
        - "{{ remote_project_path }}/workflows/n8n"
        
    - name: "ğŸ“‹ Copy configuration file"
      copy:
        src: "{{ playbook_dir }}/../../config.env"
        dest: "{{ remote_project_path }}/config.env"
        owner: "{{ homeai_user }}"
        group: "{{ homeai_group }}"
        mode: '0644'
        
    - name: "ğŸ³ Copy Docker Compose file"
      copy:
        src: "{{ playbook_dir }}/../../docker/docker-compose.yml"
        dest: "{{ remote_project_path }}/docker-compose.yml"
        owner: "{{ homeai_user }}"
        group: "{{ homeai_group }}"
        mode: '0644'
        
    - name: "ğŸ“ˆ Copy Freqtrade config file"
      copy:
        src: "{{ playbook_dir }}/../../docker/services/freqtrade/config.json"
        dest: "{{ remote_project_path }}/services/freqtrade/config.json"
        owner: "{{ homeai_user }}"
        group: "{{ homeai_group }}"
        mode: '0644'
        
    - name: "ğŸ“ˆ Copy Freqtrade strategy file"
      copy:
        src: "{{ playbook_dir }}/../../docker/services/freqtrade/strategies/SimpleStrategy.py"
        dest: "{{ remote_project_path }}/services/freqtrade/strategies/SimpleStrategy.py"
        owner: "{{ homeai_user }}"
        group: "{{ homeai_group }}"
        mode: '0644'
        
    - name: "ğŸ” Copy SearXNG settings file"
      copy:
        src: "{{ playbook_dir }}/../../docker/services/searxng/settings.yml"
        dest: "{{ remote_project_path }}/services/searxng/settings.yml"
        owner: "{{ homeai_user }}"
        group: "{{ homeai_group }}"
        mode: '0644'
        
    - name: "ğŸ”„ Copy workflow templates"
      copy:
        src: "{{ playbook_dir }}/../../workflows/"
        dest: "{{ remote_project_path }}/workflows/"
        owner: "{{ homeai_user }}"
        group: "{{ homeai_group }}"
        mode: '0644'
      ignore_errors: true
        
    - name: "âš™ï¸  Create systemd service"
      template:
        src: "{{ playbook_dir }}/../templates/homeai.service.j2"
        dest: /etc/systemd/system/homeai.service
        mode: '0644'
      notify:
        - reload systemd
        - start homeai
        
    - name: "ğŸš€ Start services"
      shell: |
        cd {{ remote_project_path }}
        source config.env
        docker-compose up -d
      become_user: "{{ homeai_user }}"
      
    - name: "ğŸ”§ Enable HomeAI service"
      systemd:
        name: homeai
        enabled: yes
        daemon_reload: yes
        
    - name: "â³ Wait for services to start"
      pause:
        seconds: 30
        
    - name: "âœ… Verify core services are running"
      shell: |
        cd {{ remote_project_path }}
        docker-compose ps | awk 'NR>2 && $2 ~ /Up/ {print $1}' | sed 's/_[0-9]*$//'
      become_user: "{{ homeai_user }}"
      register: running_services
      failed_when: false
      
    - name: "ğŸ“Š Service status summary"
      debug:
        msg: |
          ğŸŸ¢ Running services: {{ running_services.stdout_lines | join(', ') if running_services.stdout_lines | length > 0 else 'None detected' }}
          ğŸ“ˆ Total running: {{ running_services.stdout_lines | length }}/6 expected services
          
          ğŸ§ª FlowLab Architecture:
          â€¢ N8N: Workflow automation platform
          â€¢ SearXNG: Privacy-focused search (with JSON API enabled)
          â€¢ Freqtrade: Market data API (optional - workflows use CoinGecko)
          â€¢ PostgreSQL: Database backend
          â€¢ Portainer: Container management
          â€¢ Watchtower: Auto-updates
          
          ğŸ“ Troubleshooting:
          â€¢ Check logs: ./scripts/helpers/logs.sh [service_name]
          â€¢ Full status: docker-compose ps
          â€¢ Enhanced crypto scanner uses CoinGecko API (no Freqtrade dependency)
          
    - name: "ğŸ” Debug: Show raw docker-compose output"
      shell: |
        cd {{ remote_project_path }}
        echo "=== Docker Compose PS Output ==="
        docker-compose ps
        echo "=== Docker Container List ==="
        docker ps -a
      become_user: "{{ homeai_user }}"
      register: debug_output
      when: running_services.stdout_lines | length == 0
      
    - name: "ğŸ› Debug output"
      debug:
        msg: "{{ debug_output.stdout_lines }}"
      when: running_services.stdout_lines | length == 0 and debug_output is defined

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: true
        
    - name: start homeai
      systemd:
        name: homeai
        state: started

  post_tasks:
    - name: "ğŸ‰ Deployment completed successfully"
      debug:
        msg: |
          ğŸ§ª FlowLab Successfully Deployed! ğŸ§ª
          Your personal automation laboratory is ready!
          
          ğŸ  Local Services:
          ğŸ“Š N8N:          http://{{ ansible_host }}:5678
          ğŸ” SearXNG:      http://{{ ansible_host }}:8080 (JSON API enabled)
          ğŸ“ˆ Freqtrade:    http://{{ ansible_host }}:8081 (optional)
          ğŸ³ Portainer:    http://{{ ansible_host }}:9000
          
          ğŸš€ Ready-to-Use Workflows:
          â€¢ Enhanced Crypto Scanner (uses CoinGecko API)
          â€¢ News sentiment analysis via SearXNG
          â€¢ Technical analysis with RSI, MACD, EMAs
          â€¢ Telegram notifications ready
          
          ğŸ“ Recent Improvements:
          â€¢ SearXNG JSON API properly configured
          â€¢ Simplified architecture using CoinGecko
          â€¢ Enhanced error handling and reliability
          â€¢ All configuration files properly mounted
          
          ğŸ“‹ Next Steps:
          1. Import workflows from /workflows/n8n/ in N8N
          2. Configure Telegram bot credentials
          3. Test the Enhanced Crypto Scanner workflow
          
          ğŸ“ Notes:
          â€¢ Services may take 2-3 minutes to fully start
          â€¢ All configurations are clean - set your own passwords
          â€¢ Data persists across deployments
          â€¢ Auto-updates run daily at 2 AM
 